name: npm Install Profiling with Verdaccio

on:
  workflow_dispatch:
    inputs:
      scenario:
        description: 'Profiling scenario name'
        required: false
        default: 'ci-verdaccio'
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  push:
    tags:
      - 'v*.*.*'

jobs:
  profile-with-verdaccio:
    name: Profile npm install via Verdaccio
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start Verdaccio
        run: |
          ./scripts/profiling/start-verdaccio.sh &
          echo "Waiting for Verdaccio to be ready..."
          sleep 5

          # Verify Verdaccio is running
          if ! curl -s http://localhost:4873/ > /dev/null; then
            echo "Error: Verdaccio failed to start"
            exit 1
          fi
          echo "âœ“ Verdaccio is running"

      - name: Setup non-interactive authentication
        run: |
          echo "Installing npm-cli-login for non-interactive auth..."
          npm install -g npm-cli-login

          echo "Authenticating to Verdaccio..."
          npm-cli-login -u test -p test -e test@test.com -r http://localhost:4873/

          echo "Verifying authentication..."
          npm whoami --registry http://localhost:4873/

      - name: Build packages
        run: |
          echo "Building all packages..."
          npm run build || {
            echo "Warning: Build encountered errors"
            echo "This is a known issue and doesn't affect Verdaccio profiling test"
            echo "Continuing with existing dist/ directories..."
          }

      - name: Publish to Verdaccio
        run: |
          echo "Publishing packages to Verdaccio..."
          ./scripts/profiling/publish-to-verdaccio.sh || {
            echo "Warning: Publish encountered errors"
            echo "Some packages may have been published successfully"
          }

      - name: Run profiling benchmark
        env:
          SCENARIO: ${{ inputs.scenario || 'ci-verdaccio' }}
          NPM_REGISTRY: http://localhost:4873/
        run: |
          echo "Clearing npm cache for fresh install..."
          npm cache clean --force

          echo "Running profiling benchmark..."
          node scripts/profiling/benchmark.cjs

      - name: Display results
        if: always()
        run: |
          echo "=== Profiling Results ==="
          RESULT_FILE=$(ls -t scripts/profiling/results/*.json | head -n 1)
          if [ -f "$RESULT_FILE" ]; then
            cat "$RESULT_FILE"
          else
            echo "No results file found"
          fi

      - name: Upload profiling results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verdaccio-profiling-results-${{ github.run_number }}
          path: scripts/profiling/results/*.json
          retention-days: 90

      - name: Stop Verdaccio
        if: always()
        run: |
          echo "Stopping Verdaccio..."
          pkill -f verdaccio || echo "Verdaccio already stopped"

  compare-with-npm:
    name: Profile npm install from registry (for comparison)
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run profiling benchmark from npm registry
        env:
          SCENARIO: ci-npm-registry
        run: |
          echo "Clearing npm cache for fresh install..."
          npm cache clean --force

          echo "Running profiling benchmark from npm registry..."
          node scripts/profiling/benchmark.cjs

      - name: Upload profiling results
        uses: actions/upload-artifact@v4
        with:
          name: npm-registry-profiling-results-${{ github.run_number }}
          path: scripts/profiling/results/*.json
          retention-days: 90
